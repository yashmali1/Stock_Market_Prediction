import streamlit as st
from datetime import date
import yfinance as yf
from prophet import Prophet
from prophet.plot import plot_plotly
from plotly import graph_objs as go
import pandas as pd
import plotly.express as px

# App title
st.title("Stock Prediction App ðŸ“ˆ")

# Sidebar for user input
st.sidebar.header("User Input")

# Define stock symbols
stocks = ("AAPL", "GOOG", "MSFT", "GME", "TSLA", "AMZN", "ZOMATO.NS", "RELIANCE.NS", "TATASTEEL.NS", "HDFCBANK.NS", "Custom")
selected_stock = st.sidebar.selectbox("Select a stock for prediction", stocks)

# Add custom stock input
if selected_stock == "Custom":
    custom_stock = st.sidebar.text_input("Enter a custom stock code (e.g., AAPL, GOOG, etc.):")
    if custom_stock:
        selected_stock = custom_stock
    else:
        st.sidebar.warning("Please enter a valid stock code.")

# Define date range
START = st.sidebar.date_input("Start date", date(2015, 1, 1))
TODAY = st.sidebar.date_input("End date", date.today())

# Define prediction period
n_years = st.sidebar.slider("Years of prediction:", 1, 5)
period = n_years * 365

# Function to load stock data
@st.cache_data
def load_data(ticker):
    data = yf.download(ticker, START, TODAY)
    data.reset_index(inplace=True)
    
    # Flatten multi-level column names
    data.columns = [col[0] if isinstance(col, tuple) else col for col in data.columns]
    
    return data

# Load data
if selected_stock:
    data_load_state = st.text("Loading data... Please Wait!")
    try:
        data = load_data(selected_stock)
        data_load_state.text("Loading data... Done!")
    except Exception as e:
        data_load_state.text(f"Error loading data: {e}")
        st.stop()
else:
    st.warning("Please select or enter a stock code.")
    st.stop()

# Debugging: Print fetched data
st.subheader("Raw Data")
st.write("This section displays the raw stock data fetched from Yahoo Finance. It includes columns like Date, Open, High, Low, Close, Adj Close, and Volume.")
st.write(data.tail())  # Display last few rows
st.write(f"Data shape: {data.shape}")  # Check data shape
st.write(data.columns)  # Check column names

# Ensure Date column is in datetime format
data["Date"] = pd.to_datetime(data["Date"])

# Plot raw data
def plot_raw_data():
    fig = go.Figure()
    
    # Add Closing Price trace
    fig.add_trace(go.Scatter(
        x=data['Date'],
        y=data['Close'],
        name='Closing Price',
        mode='lines',
        line=dict(color='blue')  # Blue color for closing price
    ))
    
    # Add Opening Price trace
    fig.add_trace(go.Scatter(
        x=data['Date'],
        y=data['Open'],
        name='Opening Price',
        mode='lines',
        line=dict(color='red')  # Red color for opening price
    ))
    
    # Update layout
    fig.update_layout(
        title_text=f"{selected_stock} Stock Prices Over Time",
        xaxis_title="Date",
        yaxis_title="Price (USD)",
        xaxis_rangeslider_visible=True
    )
    
    st.plotly_chart(fig)

st.subheader("Line Chart of Stock Data")
st.write("This chart visualizes the historical stock prices (Opening and Closing) over time. The blue line represents the Closing Price, and the red line represents the Opening Price.")
plot_raw_data()

# Prepare data for Prophet
df_train = data[['Date', 'Close']].rename(columns={"Date": "ds", "Close": "y"})

# Debugging: Print training data
st.subheader("Training Data")
st.write("This section shows the data prepared for training the Prophet model. It includes two columns: 'ds' (date) and 'y' (closing price).")
st.write(df_train.tail())

# Ensure 'y' column is numeric and handle missing/invalid values
df_train['y'] = pd.to_numeric(df_train['y'], errors='coerce')  # Convert to numeric, set invalid values to NaN
df_train = df_train.dropna()  # Drop rows with NaN values

# Debugging: Print cleaned training data
st.subheader("Cleaned Training Data")
st.write("This section displays the cleaned training data after removing any rows with missing or invalid values.")
st.write(df_train.tail())

# Train Prophet model
m = Prophet()
m.fit(df_train)

# Create future dataframe
future = m.make_future_dataframe(periods=period)

# Make predictions
forecast = m.predict(future)

# Display forecast data
st.subheader("Forecast Data")
st.write("This section shows the forecasted stock prices generated by the Prophet model. It includes columns like 'ds' (date), 'yhat' (predicted value), and uncertainty intervals.")
st.write(forecast.tail())

# Plot forecast
st.write("Forecast Plot")
st.write("This chart visualizes the predicted stock prices over time. The black dots represent historical data, and the blue line represents the forecasted values.")
fig1 = plot_plotly(m, forecast)
st.plotly_chart(fig1)

# Plot forecast components
st.write("Forecast Components")
st.write("This section breaks down the forecast into its components: trend, yearly seasonality, and weekly seasonality. It helps in understanding the underlying patterns in the data.")
fig2 = m.plot_components(forecast)
st.write(fig2)